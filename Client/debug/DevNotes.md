# Development Notes

by HurryPeng

## Core Components

### setup.bat/setup.sh

- For Windows/Ubuntu
- Assumes python3 has been installed and added to `path`
- Installs `watchdog` module for python
- Installs `websockets` module for python
- Generates `DisGraFS-Client-Register-Generated.reg`/`disgrafs.desktop` for current working directory and adds it to system configuration
- Should be re-run every time the folder is moved

### DisGraFS-Client-Register-Generated.reg/disgrafs.desktop

- For Windows/Ubuntu
- Automatically generated by `setup.bat`/`setup.sh`, can be deleted after use
- Adds `URL:disgrafs Protocol Handler` to registry or `disgrafs.desktop` to desktop database, which redirects `disgrafs://` protocol to current working directory's `DisGraFS-Client.py`

### DisGraFS-Client.py

- Intended to be platform independent, but some slight difference between platforms (for example , `sudo`) made it impossible
- First called by `disgrafs://` URL protocol, and will keep running until killed by user or server
  - Format: `disgrafs://[redisUrl] [mountPoint] [wsUrl] [wsAuth]`
  - Example: `disgrafs://redis://:disgrafs@juicefs.disgrafs.tech Z: ws://localhost:9090 admin:123456`
- Mounts JuiceFS
- Starts websocket connection as client
  - Listens to server commands
  - Command format: `{"command": "commandName", "parameter": ["param1", "param2", ...]}`
    - exit: `{"command": "exit", "parameter": []}`
    - open: `{"command": "open", "parameter": ["RollIt.jpg"]}`
- Establishes watchdog observer on mounted drive
  - Listens to filesystem events and reports to server via websocket
  - Report format: 
    - Create: `{"type": "create", "path1": "folder/newfile.txt", "path2": "", "time": 1619926181000}`
    - Modify: `{"type": "modify", "path1": "folder/modified.txt", "path2": "", "time": 1619926181000}`
    - Delete: `{"type": "delete", "path1": "folder/deleted.txt", "path2": "", "time": 1619926181000}`
    - Move: `{"type": "move", "path1": "oldfolder/oldname.txt", "path2": "newfolder/newname.txt", "time": 1619926181000}`

### juicefs.exe/juicefs

- Different binaries for different platforms
- Provided by JuiceFS
- Automatically called by `DisGraFS-Client.py`

## Debug Utilities

### CallClient.html

Instead of accessing a URL, some browsers automatically do web search when they don't think it's a URL, but a hardcoded hyperlink in `html` would force them to do so. 

### wsClient.py

Websocket client for local testing. 

### wsServer.py

Websocket server for local testing. After authenticating the client, this server would wait for filesystem event report from the client. On receiving, it would send back an `open` command to the client telling the client to open the just-operated file (unless it was deleted). Specially, if `"exit"` was included in the target filename, it woud send an `exit` comman instead. 

To test the functionality of the client, run `wsServer.py` first, then call the client with `CallClient.html` (or type the URL in a browser, whichever you like). Operate on any file in the mounted directory, and the client would report it to the server, who sends back an `open` command to the client, resulting in the client's always opening the just-operated file until an `exit` is received. If this is the case, then the client should be working properly. 

